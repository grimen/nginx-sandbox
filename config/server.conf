

# -----------------------
#  Lua App
# --------------------

default_type 'text/plain';

location / {
  try_files $maintenance $uri $uri/ last;
}

access_log 'logs/access.log';
error_log 'logs/error.log';

# Lua: Hello
location /examples/hello.lua {
  access_log 'logs/examples.hello.access.log';
  error_log 'logs/examples.hello.error.log' error;

  include 'endpoint.conf';
  try_files $maintenance @hello;
}

# Lua: Redis
location /examples/redis.lua {
  access_log 'logs/examples.redis.access.log';
  error_log 'logs/examples.redis.error.log';

  include 'endpoint.conf';
  try_files $maintenance @redis;
}

# Lua: WebSocket
location /examples/websocket.lua {
  if ($http_upgrade != 'websocket') {
    return 'http://$host:$server_port/websocket.html';
  }

  access_log 'logs/examples.websocket.access.log';
  error_log 'logs/examples.websocket.error.log' error;

  include 'endpoint.conf';
  try_files $maintenance @websocket;
}

# Lua: LuaRocks
location /examples/luarocks.lua {
  access_log 'logs/examples.luarocks.access.log';
  error_log 'logs/examples.luarocks.error.log' error;

  include 'endpoint.conf';
  try_files $maintenance @luarocks;
}

# Nginx: Auth
location /examples/auth {
  access_log 'logs/examples.auth.access.log';
  error_log 'logs/examples.auth.error.log' error;

  include 'auth.conf';
  try_files $maintenance @hello;
}

# Nginx: Redirect
location /examples/redirect {
  access_log 'logs/examples.redirect.access.log';
  error_log 'logs/examples.redirect.error.log';

  return 301 '$scheme://$host:$server_port/examples/hello.lua?referer=$referer';
}

# Nginx: Rewrite
location /examples/rewrite {
  access_log 'logs/examples.rewrite.access.log';
  error_log 'logs/examples.rewrite.error.log' error;

  rewrite '^/examples/rewrite$ /examples/hello.lua?referer=$referer' permanent;
}

# Nginx: Return Status
location /examples/status {
  access_log 'logs/examples.status.access.log';
  error_log 'logs/examples.status.error.log' error;

  return 403;
}

# Nginx: Return Body
location /examples/body {
  access_log 'logs/examples.body.access.log';
  error_log 'logs/examples.body.error.log' error;

  default_type 'text/json';
  return 200 '{"foo": "bar"}';
}

# Nginx: Echo
#   - https://github.com/agentzh/echo-nginx-module
location /examples/echo {
  access_log 'logs/examples.echo.access.log';
  error_log 'logs/examples.echo.error.log' error;

  echo_reset_timer;
  echo hello;
  echo_location '/examples/hello.lua?x=sync1';
  echo_location '/examples/hello.lua?x=sync2';
  echo_sleep 1.0; # sleep in seconds
  echo_flush; # ensure the client can see previous output immediately
  echo_location_async '/examples/hello.lua?x=async1';
  echo_location_async '/examples/hello.lua?x=async2';
  echo world;
  echo $echo_timer_elapsed;
  echo_status 200;
}

# Nginx: MD5
#   - https://github.com/agentzh/set-misc-nginx-module
location /examples/md5 {
  access_log 'logs/examples.md5.access.log';
  error_log 'logs/examples.md5.error.log' error;

  set $raw $request_uri;
  set_md5 $digest $raw;

  default_type 'text/json';
  echo '{"digest": "$digest"}';
}

# Nginx: base64
#   - https://github.com/agentzh/set-misc-nginx-module
#   - https://github.com/agentzh/set-misc-nginx-module
location /examples/base64 {
  access_log 'logs/examples.base64.access.log';
  error_log 'logs/examples.base64.error.log' error;

  set $raw $request_uri;
  set_encode_base64 $digest_encode $raw;
  set_decode_base64 $digest_decode $digest_encode;

  echo '{"base64encode": "$digest_encode", "base64decode": "$digest_decode"}';
}

# Nginx: escapeuri
#   - https://github.com/agentzh/set-misc-nginx-module
location /examples/escapeuri {
  access_log 'logs/examples.escapeuri.access.log';
  error_log 'logs/examples.escapeuri.error.log' error;

  set $raw '$scheme://$host:$server_port/$uri';
  set_escape_uri $escaped_uri $raw;

  echo '{"escaped_uri": "$escaped_uri"}';
}

# Nginx: Encrypted Session
location /examples/session {
  access_log 'logs/examples.session.access.log';
  error_log 'logs/examples.session.error.log' error;

  default_type 'text/json';

  set $session "hello";

  encrypted_session_key 'abcdefghijklmnopqrstuvwxyz123456'; # 32 bytes
  encrypted_session_iv '1234567812345678'; # 16 bytes
  encrypted_session_expires 2; # seconds

  set_encrypt_session $encrypted_session $session;
  set_encode_base32 $encrypted_session;

  set $encrypted_session_cookie "session=$encrypted_session; path=/;";

  add_header 'Set-Cookie' $encrypted_session_cookie;

  echo "{ \"result\": \"$encrypted_session_cookie\" }";
}

# Example: HTTP 1.1 Link Prefetch
#   - https://developer.mozilla.org/en-US/docs/Link_prefetching_FAQ
location /examples/prefetch {
  access_log 'logs/examples.prefetch.access.log';
  error_log 'logs/examples.prefetch.error.log' error;

  add_header 'Link' '<$scheme://$host:$server_port/index.html>; rel=prefetch'; # Mozilla (HTTP 1.1)

  echo "OK";
}

# Example: SPDY Hint
#   - http://www.chromium.org/spdy/link-headers-and-server-hint
location /examples/spdyhint {
  access_log 'logs/examples.spdy-hint.access.log';
  error_log 'logs/examples.spdy-hint.error.log' error;

  # WIP
  add_header 'Link' '<$scheme://$host:$server_port/index.html>; rel=subresource'; # Chrome (SPDY)

  echo "OK";
}

# Example: SPDY Push
#   - http://www.chromium.org/spdy/link-headers-and-server-hinthttp://knowaboutspdy.blogspot.se/2013/10/hey-nginx-push-this.html
location /examples/spdypush {
  access_log 'logs/examples.spdy-push.access.log';
  error_log 'logs/examples.spdy-push.error.log' error;

  # WIP
  add_header 'X-Associated-Content' '"$scheme://$host:$server_port/index.html", "$scheme://$host:$server_port/websockets.html"'; # Chrome (SPDY)

  echo "OK";
}


# ---

location @hello {
  access_log 'logs/examples.hello.access.log';
  error_log 'logs/examples.hello.error.log' error;

  content_by_lua_file '$config/server/examples/hello.lua';
}

location @redis {
  access_log 'logs/examples.redis.access.log';
  error_log 'logs/examples.redis.error.log' error;

  content_by_lua_file '$config/server/examples/redis.lua';
}

location @websocket {
  access_log 'logs/examples.websocket.access.log';
  error_log 'logs/examples.websocket.error.log' error;

  content_by_lua_file '$config/server/examples/websocket.lua';
}

location @luarocks {
  access_log 'logs/examples.luarocks.access.log';
  error_log 'logs/examples.luarocks.error.log' error;

  content_by_lua_file '$config/server/examples/luarocks.lua';
}
